name: CI

# ðŸ” Ð¡Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² Ð²ÐµÑ‚ÐºÐ¸ dev Ð¸ main
on:
  push:
    branches:
      - dev
      - main

env: # ðŸŒ ÐžÐ±Ñ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±ÑÑ‚ÑÑ)
  NODE_VERSION: 20

jobs:
  lint:
    name: Lint apps
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (Ð¸Ð¼Ð¼ÑƒÑ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°)
        run: yarn install --immutable

      - name: âœï¸ Ð›Ð¸Ð½Ñ‚ backend
        run: yarn workspace backend run lint

      - name: âœï¸ Ð›Ð¸Ð½Ñ‚ frontend
        run: yarn workspace frontend run lint

  build:
    name: Build apps
    runs-on: ubuntu-latest
    needs: lint # âš ï¸ Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ lint

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        run: yarn install --immutable

      - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° shared
        run: yarn workspace shared run build

      - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° backend
        run: yarn workspace backend run build

      - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° frontend
        run: yarn workspace frontend run build

  deploy:
    if: github.ref == 'refs/heads/main' # ðŸš€ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main
    name: Deploy
    runs-on: ubuntu-latest
    needs: build # â³ Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸

    environment:
      name: production # ðŸŒ ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ GitHub Environments

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        run: yarn install --immutable

      - name: ðŸš€ Deploy (Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°)
        run: echo "ðŸŽ¯ Ð”Ð¾Ð±Ð°Ð²ÑŒ ÑÑŽÐ´Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´ÐµÐ¿Ð»Ð¾Ñ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, SSH, Docker, rsync Ð¸ Ñ‚.Ð´."

      # ÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±ÑÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· GitHub Secrets
      # - name: ðŸ” Set env vars
      #   run: echo "API_URL=${{ secrets.API_URL }}" >> $GITHUB_ENV