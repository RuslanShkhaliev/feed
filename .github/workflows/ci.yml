name: CI

# ðŸ” Ð¡Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² Ð²ÐµÑ‚ÐºÐ¸ dev Ð¸ main
on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main"]

env: # ðŸŒ ÐžÐ±Ñ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±ÑÑ‚ÑÑ)
  NODE_VERSION: 22

jobs:
  setup:
    name: ðŸ“¦ Install
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ðŸ”§ Enable Corepack
        run: corepack enable

      - name: âš™ï¸ Use project Yarn version
        run: corepack prepare yarn@4.7.0 --activate

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{env.NODE_VERSION}}
          cache: 'yarn'

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        run: yarn install --immutable


      - name: ðŸ“¦ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
        uses: actions/upload-artifact@v4
        with:
          name: project-source
          path: |
            ./
            .yarn/**
            .yarnrc.yml
          retention-days: 1

  lint:
    name: âœï¸ Lint apps
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ðŸ”§ Enable Corepack
        run: corepack enable

      - name: âš™ï¸ Use project Yarn version
        run: corepack prepare yarn@4.7.0 --activate

      - name: ðŸ“¦ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        uses: actions/download-artifact@v4
        with:
          name: project-source
          path: .

      - name: âœï¸ Eslint
        run: yarn lint

  build:
    name: ðŸ› ï¸ Build apps
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ðŸ”§ Enable Corepack
        run: corepack enable

      - name: âš™ï¸ Use project Yarn version
        run: corepack prepare yarn@4.7.0 --activate

      - name: ðŸ“¦ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        uses: actions/download-artifact@v4
        with:
          name: project-source
          path: .

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        run: yarn install --immutable

      - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ°
        run: yarn run build

  deploy:
    if: github.ref == 'refs/heads/main' # ðŸš€ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main
    name: Deploy
    runs-on: ubuntu-latest
    needs: build

    environment:
      name: production

    steps:
      - name: ðŸ”§ Enable Corepack
        run: corepack enable

      - name: âš™ï¸ Use project Yarn version
        run: corepack prepare yarn@4.7.0 --activate

      - name: ðŸ“¦Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        uses: actions/download-artifact@v4
        with:
          name: product-source
          path: .

      - name: ðŸš€ Deploy (Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ°)
        run: echo "ðŸŽ¯ Ð”Ð¾Ð±Ð°Ð²ÑŒ ÑÑŽÐ´Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´ÐµÐ¿Ð»Ð¾Ñ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, SSH, Docker, rsync Ð¸ Ñ‚.Ð´."

      # ÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±ÑÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· GitHub Secrets
      # - name: ðŸ” Set env vars
      #   run: echo "API_URL=${{ secrets.API_URL }}" >> $GITHUB_ENV